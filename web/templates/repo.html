{% extends "layout.html" %}
{% block title %}{{repo.name|basename}}{%endblock%}
    {% block head_extra %}
		<script type="text/javascript" src="/static/js/ZeroClipboard.min.js"></script>
		<script type="text/javascript" src="http://notifyjs.com/dist/notify-combined.min.js"></script>
	{% endblock %}
	{% block body %}
		{% block repohead %}
			<div class="container row">
				<p class="pull-right">Updated {{repo.updated|naturaltime}}</p>
				<span style="font-size:20px">
				<a href="/repo/{{repo.name}}"><strong>{{repo.name}}</strong></a>
				<a href="https://{{repo.name}}" class="btn btn-info btn-xs">Source</a>
				<br>
				<span class="glyphicon glyphicon-cloud-download"></span> {{repo.down_count}}
				<!--<a href="/repo/{{repo.name}}#disqus_thread">Link</a>-->
				</span>
				<br>
				<p>{{repo.description}}</p>
				<div class="pull-left">
					<!--<a href="https://godoc.org/{{repo.name}}"><img src="https://godoc.org/{{repo.name}}?status.svg" alt="GoDoc"></a>-->
					<!--<a href="https://gowalker.org/{{repo.name}}"><img src="http://gowalker.org/api/v1/badge" alt="GoDoc"></a>-->
					<a href="https://{{repo.name}}"><img src="http://img.shields.io/badge/GoWalker-Doc-blue.svg?style=flat"></a>
					<a href="https://{{repo.name}}"><img src="http://img.shields.io/badge/source-github-blue.svg?style=flat"></a>
					<a href="http://sourcegraph.com/{{repo.name}}"><img src="https://sourcegraph.com/api/repos/github.com/gobuild/got/.badges/status.png" alt="sourcegraph"></a>
					<img src="https://img.shields.io/badge/gobuild-download-green.svg?style=flat">
					<!--<a href="http://go-search.org/view?id={{repo.name|urlencode}}"><img src="http://go-search.org/badge?id={{repo.name|urlencode}}" alt="GoSearch"></a>-->
					<!-- Button trigger modal -->
					<button class="btn btn-link btn-sm" data-toggle="modal" data-target="#myModal">
					generate badge
					</button>
					<!-- Modal -->
					<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							
								<div class="modal-content">

								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
									<h4 class="modal-title" id="myModalLabel">
										Badge of gobuild
										<a href="http://gobuild.io/{{repo.name}}"><img src="https://img.shields.io/badge/gobuild-download-green.svg?style=flat"></a>
									</h4>
								</div>
								<div class="modal-body">
									<form role="form">
									<div class="form-group">
										<label>HTML</label>
										<input class="click-select form-control" type="text" value='<a href="http://gobuild.io/{{repo.name}}"><img src="https://img.shields.io/badge/gobuild-download-green.svg?style=flat"></a>'>
									</div>
									<div class="form-group">
										<label>Markdown</label>
										<input class="click-select form-control" type="text" value='[![Gobuild Download](https://img.shields.io/badge/gobuild-download-green.svg?style=flat)](http://gobuild.io/{{repo.name}})'>
									</div>
								</form>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="pull-right" style="margin-bottom: 10px">
					<form class="form-inline" role="form" action='/task/build'>
						<div class="form-group">
							<input type="text" class="form-control" name="tag" value="{%if active_tag%}{{active_tag}}{%else%}branch:master{%endif%}">
							<input type="hidden" name="reponame" value="{{repo.name}}">
							<button class="btn btn-info">Build Now</button>
						</div>
					</form>
				</div>
				<br>
			</div>
		{% endblock %}
		{% block info %}
			<div class="container row" style="border: 0px solid gray">
				<div class="col-md-4" style="padding: 10px 10px">
					<h4>Tags</h4>
					<div class="list-group">
						{% for build in builds %}
							<a href="/{{repo.name}}?tag={{build.tag}}"
								class="list-group-item
								{%if not build.downloadable%}
								disabled
								{%else%}
								{%if build.tag==active_tag%}active{%endif%}
								{%endif%}
								">
								{%if not build.downloadable%}<del>{%endif%}
								{{build.tag}}
								{%if not build.downloadable%}
								</del>
								{%else%}
								<span class="badge">
								<span class="glyphicon glyphicon-cloud-download"></span> {{build.down_count}}
								</span>
								{%endif%}
							</a>
						{% endfor %}
					</div>
				</div>
				<div class="col-md-8" style="padding: 10px 50px; border-left: 1px solid gray">
					<div class="row">
						<h4>Properties</h4>
						{% if build %}
							<p><span class="glyphicon glyphicon-time"></span> {{ build.updated|strftime }} - [used: {{20|human_duration}}]</p>
							<p>
							{{build.version|str2html}}
							</p>
							<a href="/task/list/{{build.id}}" class="btn btn-info btn-xs">build history</a>
							{% if build.downloadable %}
								<h5>Download</h5>
								<div>
									<table class="table">
										{% for goos, archs in osarchs %}
											<tr>
												<td>
													<button platform="{{goos}}" class="download btn btn-success btn-sm" style="width: 90px; text-align: left">
													<span class="glyphicon glyphicon-save"></span> {{goos}}
													</button>
												</td>
												<td>
													{% for arch in archs %}
														<label class="radio-inline">
															<input type="radio" name="{{goos}}-arch" value="{{arch}}" {% if arch==archs[0]%}checked{%endif%}> {{arch}}
															</label>
														{% endfor %}
													</td>
													<td style="width: 40%">
														<span class="input-group-btn">
															<button class="btn btn-default copy-button" prefix="curl -LO" platform="{{goos}}" type="button">curl</button>
															<button class="btn btn-default copy-button" prefix="wget" platform="{{goos}}" type="button">wget</button>
														</span>
													</td>
												</tr>
											{% endfor %}
										</table>
									</div>
									<div class="well" id="well"></div>
								{% else %}
									<p>
									<strong>Build Status:</strong> {{build.status}}
									</p>
								{% endif %}
							{% else %}
							<p>No history build, you are first here, click <strong>Build Now</strong> to start.
							{% endif %}
						</div>
					</div>
				</div>
				<script type="text/javascript">
				function saveas(url){
					var a = $("<a href='"+url+"'>download</a>").get(0);
					var e = document.createEvent('MouseEvents');
					e.initEvent( 'click', true, true );
					a.dispatchEvent(e);
				}
				var retrive = function(goos, goarch, async, on_success) {
					var setting = {
						url: '/repo/retrive',
						type: 'GET',
						async: async, 
						data: {reponame:"{{repo.name}}", goos: goos, goarch: goarch, tag: "{{active_tag}}"},
						success: function(d){
							console.log("message", d.message);
							var well;
							if (d.status !== 0){
								well = "<span style='color:red'>"+goos+"-"+arch+"\n"+d.message+"</span>";
							} else {
								well = d.well;
							}
							well = well.replace(new RegExp('\n','g'), '<br>');
							$("#well").html(well);
							on_success(d);
						}
					};
					$.ajax(setting);
				}
				$(".download").click(function(e){
						var goos = $(this).attr("platform")
						var xpath = "input[name="+goos+"-arch]:checked";
						var arch = $(xpath).val();
						retrive(goos, arch, false, function(d){
							if (d.status === 0){
								$("#well").prepend('<i>download will start soon.</i> '+
									'if not started click <a href="{0}">link</a><br>'.format(d.outlink));
								saveas(d.outlink);
							}
						});
				});
				var zclient = new ZeroClipboard($(".copy-button"));
				zclient.on("copy", function(event){
						var $this = $(event.target);
						var goos = $this.attr("platform")
						var xpath = "input[name="+goos+"-arch]:checked";
						var arch = $(xpath).val();
						var tag = "{{active_tag}}"
						var clipboard = event.clipboardData;
						retrive(goos, arch, false, function(d){
							var prefix = $this.attr("prefix") || "";
							var suffix = $this.attr("suffix") || "";
							var copydata = prefix + " " + d.outlink + " " + suffix;
							clipboard.setData("text/plain", copydata);
							$this.parent("span").notify("copied to clipboard", 
								{position: "top", className: 'success', autoHideDelay: 1000});
							$("#well").prepend("<code>"+copydata+"</code><br>");
						});
				})
				</script>
			{% endblock %}
			{% block disqus %}
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
				var disqus_shortname = 'gobuild'; // required: replace example with your forum shortname
				/* * * DON'T EDIT BELOW THIS LINE * * */
				$(function(){
				(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('body')[0] || document.getElementsByTagName('head')[0]).appendChild(dsq);
				})();
				});
					/* comment count */
				(function () {
					var s = document.createElement('script'); s.async = true;
					s.type = 'text/javascript';
					s.src = '//' + disqus_shortname + '.disqus.com/count.js';
					(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
				}());
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			{% endblock %}
		{% endblock %}
